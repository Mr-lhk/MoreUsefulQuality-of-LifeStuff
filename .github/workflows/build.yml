name: NeoForge 1.21.1 CI & Release

# 触发器配置
on:
  push:
    branches: [ "main", "develop" ] # 推送这两个分支时触发构建检查
    tags: [ "v*" ]                # 推送以 v 开头的标签时触发发布流程（如 v1.0.0）
  pull_request:
    branches: [ "main" ]          # 提交到 main 的 PR 触发构建检查
  workflow_dispatch:              # 手动触发构建

# 防止同一个分支多次提交导致构建任务堆叠
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --- 任务 1：构建 JAR 包 ---
  build:
    name: Build and Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4 # 检出源码

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin' # 配置 Java 21 (NeoForge 1.21.1 必须)

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 'wrapper'
          cache-read-only: false

      - name: Grant Execute Permission
        run: chmod +x gradlew # 赋予 Gradle 执行权限

      - name: Run Gradle Build
        run: ./gradlew build # 运行构建

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-libs
          path: build/libs/
          retention-days: 1 # 临时保存构建产物

  # --- 任务 2：创建 GitHub Release ---
  release:
    name: Create GitHub Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') # 只有推了 Tag 才运行本任务
    runs-on: ubuntu-latest
    permissions:
      contents: write # 关键：必须赋予写入权限才能创建 Release

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4 # 检出源码

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-libs
          path: dist # 下载之前构建好的产物

      - name: Clean Unnecessary JARs
        # 重点修复：过滤掉 sources 和 dev 等非运行包
        run: |
          find dist/ -type f ! -regex ".*-[0-9].*\.jar" -delete
          find dist/ -type f -name "*-sources.jar" -delete
          find dist/ -type f -name "*-dev.jar" -delete
          ls -l dist/

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.jar # 上传 dist 目录下剩余的 JAR 包
          generate_release_notes: false # 关闭基于commit信息的changelog
          # 如果是测试版，可以在 Tag 名里带上 -pre 或 -alpha，这里会自动识别
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # 这是一个自动生成的 Token，无需手动配置